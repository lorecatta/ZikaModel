---
title: "Run a stochastic model"
author: "Lorenzo Cattarino"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Run a stochastic model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
library(ZikaModel)
```

## Stochasticity 
The `ZikaModel` package implements also a stochastic version of the Zika 
transmission model. To avoid confusion, the stochastic version of the model is 
written as a different odin source file. To run the stochastic model, we need 
to create a `model generator`, which is a function that will generate an 
instance of the stochastic model, using the specified path to the odin source file.

The following code will do this:

```{r}
age_init <- c(1, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10)
  
deathrt <- c(1e-10, 
             1e-10, 
             1e-10, 
             0.00277068683332695, 
             0.0210680857689784,
             0.026724997685722,
             0.0525354529367476,
             0.0668013582441452,
             0.119271483740379,
             0.279105747097929,
             0.390197266957464)

# path to odin source file
odin_model_path <- system.file("extdata/odin_model_stoch.R", package = "ZikaModel")

create_generator <- create_r_model(odin_model_path,
                                   agec = age_init,
                                   death = deathrt,
                                   nn_links,
                                   amplitude_phases,
                                   season = TRUE)

# model generator 
gen <- create_generator$generator(user = create_generator$state)
```

Now run the model.

```{r}
time_frame <- 364 * 100

# runs the model
model_run <- gen$run(seq(0, time_frame, 1))
```

We reshape the model outputs with the following command

```{r}
stoch_out <- gen$transform_variables(model_run)
```

And finally postprocessing and plotting with 

```{r, fig.height = 4, fig.width = 6}
diagnostics <- post_processing(stoch_out)

plot_compartments(diagnostics$compartments)
```

```{r, fig.height = 6, fig.width = 8}
plot_demographics(diagnostics$demographics)
```
