---
title: "Run a customized model"
author: "Lorenzo Cattarino"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Run a custom model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Customized models

`ZikaModel` allows the user to change the value of all the model parameters defined in `model_param_list_create()`. This allows more flexibility in the range of scenarios considered (e.g. inteventions to control the disease). Also, by taking advantage of this feature it is also possible to simulate the transmission dynamics of other immunizing single-strain infections transmitted by _Aedes aegypti_ mosquitoes, such as chikungunya. 

Here we will demonstrate how run a customized model which simulates general vector control. There are three parameters which simulate general vector control in the model:

* `propMwtControl` - the increase in mortality of adult wild type mosquitoes induced by the control
* `TimeMwtControlOn` - the time when the control starts
* `TimeMwtControlOff` - the time when the control ends

Let's assume that control increases mortality of adults mosquitoes by 20%. For now we will use the default values of `TimeMwtControlOn` and `TimeMwtControlOff`, which will simulate control for one year starting on the second year of the simulation. 

```{r}
library(ZikaModel)

age_init <- c(1, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10)

deathrt <- c(1e-10,
             1e-10,
             1e-10,
             0.00277068683332695,
             0.0210680857689784,
             0.026724997685722,
             0.0525354529367476,
             0.0668013582441452,
             0.119271483740379,
             0.279105747097929,
             0.390197266957464)

time_years <- 50

my_dt <- 1

time_frame <- (364 * time_years) / my_dt

propMwtControl <- 0.2
```

Running a customized model requires to use a the `create_r_model()` function. When called it returns a function that generates an instance of the model and we can use that instance to run the model with user-defined parameters. The function `create_r_model()` has an argument `...` which passes arguments to `model_param_list_create()` thus overriding the defaults values of the model parameters. To keep it simple we will assume no effect of seasonality across patches. This is analogous to run the model with only one patch.

```{r}
params <- list(DT = my_dt,
               season = FALSE,
               propMwtControl = propMwtControl)

odin_model_path <- system.file("extdata/odin_model_determ.R", package = "ZikaModel")

create_generator <- create_r_model(odin_model_path = odin_model_path,
                                   agec = age_init,
                                   death = deathrt,
                                   nn_links = nn_links,
                                   amplitudes_phases = amplitudes_phases,
                                   params = params)

# this generates an instance of the model using an initial equilibrium initialisation state 
gen <- create_generator$generator(user = create_generator$state)

integer_time_steps <- (364 * time_years) / my_dt

its <- seq(0, integer_time_steps, 1)

# run the model
mod_run <- gen$run(its)

# post processing
model_outputs <- gen$transform_variables(mod_run)
```

Now processing and plotting, as done before: 

```{r, fig.height = 4, fig.width = 6}
diagnostics <- post_processing(model_outputs, my_dt)

plot_compartments(diagnostics$compartments)
```

```{r, fig.height = 6, fig.width = 8}
plot_demographics(diagnostics$demographics)

mosquito_diagnostics <- post_processing_mos(model_outputs)

plot_demographics(mosquito_diagnostics)
```

```{r, fig.height = 6, fig.width = 8}
season_vars <- plot_Kc_eip_delta(model_outputs)
grid::grid.draw(season_vars)
```
