---
title: "Run a base model"
author: "Lorenzo Cattarino"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Run a base model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Running the base model
Here we consider a deterministic model without seasonality and interventions. By defaut the model uses Brazil demographics (annual per capita birth and death rates) ofr the human compartments. This will likeley be modifed in future versions. 
We run the deterministic version of the model with `run_deterministic_model()`:

```{r}
r1 <- run_deterministic_model(time_period = 365 * 5)
```

The returned object is a Zika_model_simulation object, which is a list of two ojects:

* `output` - model output
* `parameters` - model parameters

`Zika_model_simulation` objects can be plotted as follows:

```{r}
plot(r1, type = "H")
```

This will plot all human compartments of the model. The argument `type` is used to specify which part of the model we want to plot, the human (`H`) or the mosquito (`M`) part. We can select which compartment to plot with the `var_select` argument. Arguments passed to `var_select` must be one of the variables in the above plot. 

```{r}
plot(r1, type = "H", var_select = c("S", "I1"))
```

Alternatively one of the following variables can be selected: 

* `Ntotal` - total size of the human population  
* `inf_1` - daily incidence of infections
* `MC` - daily incidence of microcepahly cases 
* `inf_1_w` - weekly incidence of infections per 1000 individuals 
* `MC_w` - weekly incidence of microcepahly cases per 1000 individuals.

First we plot the daily infections

```{r}
plot(r1, type = "H", var_select = "inf_1")
```

and then the numebr of microcephaly cases 

```{r}
plot(r1, type = "H", var_select = "inf_1")
```

By default the plot function uses internally the `format_output_H()` or the `format_output_M()` function, depending on the value of the `type` argument. Here we extract the `S` compartment 

```{r}
S_output <- format_output_H(r1, var_select = "S")
head(S_output)
```

By using the `keep` argument we can extract the value of these variables for each of the 21 patches or each of the two vaccine status (1 = non vaccinated, 2 = vaccinated). Now the output has an additional column for the patch:

```{r}
S_output <- format_output_H(r1, var_select = "S", keep = "patch")
head(S_output)
```

An now we can specify the same arguments in the plot function to plot the `S` compartment by patch:

```{r}
plot(r1, type = "H", var_select = "S", keep = "patch")
```

As a sanity check, we also plot the variables which are directly modified by seasonal forcing, namely mosquito larve carrying capacity (Kc), extrinsic incubation period (eip) and adult mosquito mortality rate (Delta), and the reproduction number ($R_0$). We can make use of the function `format_output_M()`, which is used internally to plot and which allows to format the model outputs. The function `format_output_M()` by default extracts the mean value of `Kc`, `eip` and `Delta` across patches. Once we have extracted the model output we can write our own plotting code. 

```{r}
library(ggplot2)
library(patchwork)

Kc <- format_output_M(r1, var_select = "Kc")
Kc_p <- ggplot(Kc, aes(x = t, y = y)) +
  geom_line(color = 'royalblue', size = 0.5) +
  scale_x_continuous("Time") +
  scale_y_continuous("Mean across patches") +
  ggtitle("Mosquito larvae carrying capacity") +
  theme_bw()

eip <- format_output_M(r1, var_select = "eip")
eip_p <- ggplot(eip, aes(x = t, y = y)) +
  geom_line(color = 'royalblue', size = 0.5) +
  scale_x_continuous("Time") +
  scale_y_continuous("Mean across patches") +
  ggtitle("Extrinsic Incubation Period") +
  theme_bw()

delta <- format_output_M(r1, var_select = "Delta")  
delta_p <- ggplot(delta, aes(x = t, y = y)) +
  geom_line(color = 'royalblue', size = 0.5) +
  scale_x_continuous("Time") +
  scale_y_continuous("Mean across patches") +
  ggtitle("Adult mosquito daily mortality rate") +
  theme_bw()

Rt <- format_output_M(r1, var_select = "R0t_1")  
Rt_p <- ggplot(Rt, aes(x = t, y = y)) +
  geom_line(color = 'royalblue', size = 0.5) +
  scale_x_continuous("Time") +
  scale_y_continuous("Mean across patches") +
  ggtitle("Time varying reprodution number") +
  theme_bw()

all <- Kc_p + eip_p + delta_p + Rt_p
  plot_layout(guides = 'collect')
all
```
A expcted the mean value of `Kc`, `eip` and `Delta` does no change throughout the simulation when seasonality is turned off.
